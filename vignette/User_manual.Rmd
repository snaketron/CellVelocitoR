---
title: "cellvel: quantifying cell migration speed with hierarchical Bayesian models"
author: "Simo Kitanovski (simo.kitanovski@uni-due.de)"
output:
  BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{User Manual: cellvel}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include = FALSE, warning = FALSE}
knitr::opts_chunk$set(comment = FALSE, warning = FALSE, message = FALSE)
```


# Background

```{r}
library(cellvel)
library(ggplot2)
library(ggforce)
library(patchwork)
ggplot2::theme_set(new = theme_bw(base_size = 10))
```


# Data (raw)

```{r}
data("d", package = "cellvel")
head(d)
```

```{r, fig.width=6, fig.height=4}
ggplot(data = d)+
  geom_sina(aes(x = paste0("b=", batch, ", g=", group), col = replicate, y= v))+
  theme_bw()+
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  xlab(label = "batch (b) and group (g)")
```


# Data (scaled)

```{r, fig.width=6, fig.height=4}
ggplot(data = d)+
  geom_sina(aes(x = paste0("b=", batch, ", g=", group), col = replicate, 
                y=v/max(v)))+
  theme_bw()+
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  xlab(label = "batch (b) and group (g)")+
  ylab(label = "sv")
```


# Model

```{r}
o <- cellvel::cellvel(x = d, control = list(mcmc_chains = 3, mcmc_cores = 3))
```


# PPC: most observations (points) fall within the 95% HDIs of the model predictions (error bars)

```{r, fig.width=6, fig.height=3}
ggplot()+
  geom_sina(data = o$x,
            aes(x = paste0("b=", batch, ", g=", group), col=replicate, y = sv))+
  geom_errorbar(data = o$s$yhat,
                aes(x = paste0("b=", batch, ", g=", group), group = replicate, 
                    y = mean, ymin = X2.5., ymax = X97.5.), width = 0.15,
                position = position_dodge(width = 1), col = "black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```



# Results 

## Effects on cell speed + 95% highest density intervals (HDIs)

```{r, fig.width=5, fig.height=4}
g1 <- ggplot(data = o$s$eff_rep)+
  geom_point(aes(x = replicate, y = mean))+
  geom_errorbar(aes(x = replicate, y = mean, ymin = X2.5., 
                    ymax = X97.5.), width = 0.1)+
  ggtitle(label = "replicate-effect")

g2 <- ggplot(data = o$s$eff_batch)+
  geom_point(aes(x = batch, y = mean))+
  geom_errorbar(aes(x = batch, y = mean, ymin = X2.5., 
                    ymax = X97.5.), width = 0.1)+
  ggtitle(label = "batch-effect")

g3 <- ggplot(data = o$s$eff_group)+
  geom_point(aes(x = group, y = mean))+
  geom_errorbar(aes(x = group, y = mean, ymin = X2.5., 
                    ymax = X97.5.), width = 0.1)+
  ggtitle(label = "group-effect")

(g1|g2)/g3
```


## Effects on cell speed dispersion + 95% HDIs

```{r, fig.width=5, fig.height=4}
g1 <- ggplot(data = o$s$var_rep)+
  geom_point(aes(x = replicate, y = mean))+
  geom_errorbar(aes(x = replicate, y = mean, ymin = X2.5., 
                    ymax = X97.5.), width = 0.1)+
  ggtitle(label = "replicate-dispersion")

g2 <- ggplot(data = o$s$var_batch)+
  geom_point(aes(x = batch, y = mean))+
  geom_errorbar(aes(x = batch, y = mean, ymin = X2.5., 
                    ymax = X97.5.), width = 0.1)+
  ggtitle(label = "batch-dispersion")

g3 <- ggplot(data = o$s$var_group)+
  geom_point(aes(x = group, y = mean))+
  geom_errorbar(aes(x = group, y = mean, ymin = X2.5., 
                    ymax = X97.5.), width = 0.1)+
  ggtitle(label = "group-dispersion")

(g1|g2)/g3
```





# Session Info

```{r}
sessionInfo()
```

